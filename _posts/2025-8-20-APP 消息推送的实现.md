---
title: APP 消息推送的实现
date: 2025-08-20 22:00:03 +0800
tags: uniapp
categories: 技术
---

# 前言

消息推送包含在线推送和离线推送两个部分，推荐使用官方的 uniPush。

# 推送类别

## **在线推送**

APP 在前台时进行消息推送，这个Android没有什么特要注意的，IOS系统收到推送消息后不会主动发出通知栏消息，需要在接收到 receive 事件后手动创建通知栏消息。

## **离线推送**

需要在 https://dev.dcloud.net.cn/pages/app/push2/thirdparty unipush下开通对应厂商的推送服务并配置到平台上，然后再 HbuilderX 中，勾选对应离线推送的手机厂商 SDK。需要注意的是：如果unipush没有配置对应厂商，勾选之后是无法打包的，会弹出报错提示，且必须云打包推送才会生效。

目前华为、荣耀、魅族、[oppo（测试环境）](https://open.oppomobile.com/new/developmentDoc/info?id=11257)不要求上架应用商店；vivo 、小米、[oppo（正式环境）](https://open.oppomobile.com/new/developmentDoc/info?id=11257)必须上架应用商店后才可使用离线厂商推送。

Android 厂商有离线推送的额度限制，基本都限制单设备单应用每天只能收到 2 条普通消息。详见：[厂商通道限额&QPS说明](https://docs.getui.com/getui/mobile/vendor/qps/)

### **坑点**

**华为机型需要额外检查：**

* 需要在华为开发者后台配置正确的 sha256 指纹证书（需要使用keytool工具查看证书详细信息）
* 云打包用自有证书打正式签名包
* 华为开发者后台包名跟客户端包名需要保持一致
* 厂商推送设置-华为厂商，必须上传agconnect-services.json
* 在华为平台是否开通了华为推送服务
* 保存完参数，需要重新提交云端打包

确认CID是否绑定厂商token：见 [uni-push 1.0常见问题 - DCloud问答](https://ask.dcloud.net.cn/article/36611)

**苹果需要生成新的证书：**

苹果使用推送功能，需要到苹果开发者中心配置推送证书，同时勾选启用推送功能的选项，勾选后需重新生成新的证书，用新的证书打包。

### 厂商推送配置情况

| **厂商** | **uniPush配置情况** | **厂商开发者中心**                                               | **备注**                                                                                                                                                                                                                                      |
| ---------------- | --------------------------- | ------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| IOS            | 已配置，使用P8证书        | https://developer.apple.com/                                           |                                                                                                                                                                                                                                                    |
| 华为           | 已配置                    | https://developer.huawei.com/consumer/cn/service/josp/agc/index.html#/ | get hms token failed:6003: certificate fingerprint errorhttps://blog.csdn.net/weixin\_43835425/article/details/124847130实测正式环境离线推送只能收到2条消息，超过2条无法再接收到。                                                                  |
| 荣耀           | 已配置                    | https://developer.honor.com/cn/home                                    |                                                                                                                                                                                                                                                    |
| 小米           | 已配置                    | https://dev.mi.com/xiaomihyperos                                       |  |
| OPPO           | 已配置                    | https://push.oppo.com/                                                 |                                                                                                                                                                                                                                                    |
| VIVO           | 已配置                    | https://dev.vivo.com.cn/documentCenter/doc/281                         |                                                                                                                                                                                                                                                    |
| 魅族           | 已配置                    | http://open.flyme.cn/                                                  |                                                                                                                                                                                                                                                    |

# 代码实现

```JavaScript
export class pushModel {
    constructor() {
        this.systemInfo = uni.getSystemInfoSync()
        console.log('systemInfo', this.systemInfo)
    }

    // 获取推送cid
    getClientId() {
        return new Promise((resolve) => {
            plus.push.getClientInfoAsync((info) => {
                const cid = info['clientid']
                console.log('cid：', cid)
                resolve(cid)
            })
        })
    }

    // 关联推送cid
    async setPushClientId() {
        console.log('setPushClientId')
        setTimeout(async () => {
            const cid = await this.getClientId()
            const params = {
                cid,
                type: this.systemInfo.osName == 'ios' ? 'ios' : 'android',
            }
            setPushClientIdApi(params)
        })
    }

    // 解除推送cid
    async removePushClientId() {
        try {
            const cid = await this.getClientId()
            const params = {
                cid,
            }
            removePushClientIdApi(params)
        } catch (e) {}
    }

    // 监听推送消息
    bindPushMessage() {
        console.log('bindPushMessage')
        const This = this

        plus.push.addEventListener('click', handlePush)

        plus.push.addEventListener('receive', handlePush)

        function handlePush(res) {
            console.log('收到推送消息：', res)

            // 在线推送消息
            if (res.type == 'receive') {
                if (This.systemInfo.osName == 'ios') {
                    This.createPushMessage(res)
                }
            } else {
                // 通知栏消息点击
                // 安卓在线推送不会携带type参数，按照点击事件处理
                navigateTo('webview/webview', {
                    webview: JSON.stringify({
                        url: 'reminder-history',
                        needTokenRender: false,
                    }),
                })
            }
        }
    }

    // 手动创建消息提醒
    createPushMessage(res = {}) {
        console.log('createPushMessage')

        const data = res.payload || {}

        uni.createPushMessage({
            title: data.title || '把手案例',
            content: data.content || '您有一条新的提醒',
            payload: {
                type: 'click',
            },
            success: () => {
                console.log('手动创建通知消息成功')
            },
            fail: (err) => {
                console.log('手动创建通知消息失败', err)
            },
        })
    }
}
```

# 开发过程遇到的问题

## 安卓装APP后默认关闭通知权限

安卓需要在进入到提醒界面后做出校验，如果通知权限未启用，则给出提示

```JavaScript
judgeAppPushPermission() {
    const notificationAuthorized = uni.getAppAuthorizeSetting()?.notificationAuthorized
    console.log('judgeAppPushPermission', notificationAuthorized)
    return notificationAuthorized === 'authorized'
}

goToAppPermissionSetting() {
    uni.openAppAuthorizeSetting()
}
```

# **相关文档**

1. [iOS 推送证书配置指南-个推文档中心](https://docs.getui.com/getui/mobile/ios/apns/)
2. [厂商应用开通指南-个推文档中心](https://docs.getui.com/getui/mobile/vendor/vendor_open/)
3. [uni-push 1.0常见问题 - DCloud问答](https://ask.dcloud.net.cn/article/36611)
4. [iOS打包“doesn't support the Push Notifications capability”错误解决方法 - DCloud问答](https://ask.dcloud.net.cn/article/1088)
